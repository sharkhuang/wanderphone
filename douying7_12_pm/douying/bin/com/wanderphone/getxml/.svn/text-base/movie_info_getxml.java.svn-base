package com.android.getxml;

import java.io.IOException;
import java.net.URL;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.List;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;


public class movie_info_getxml {
	public List<Movie_info> find_xml(String edit_input_name) 
		throws ParserConfigurationException, SAXException, IOException{
		List<Movie_info> result_list = new ArrayList<Movie_info>();
		String utf_name = URLEncoder.encode(edit_input_name, "utf-8");

		/*
		 * http://api.douban.com/movie/subjects?apikey=0eb5e315196f06252c21a93f4c4d126f&tag=里约大冒险&start-index=1&max-results=2
		 * */
		String url_string = "http://api.douban.com/movie/subjects?apikey=0eb5e315196f06252c21a93f4c4d126f&tag=" 
			+ utf_name + "&start-index=1"; //&max-results=2";
		
		URL url = new URL(url_string);
		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
		DocumentBuilder builder = factory.newDocumentBuilder();
		Document doc = builder.parse(url.openStream());
		NodeList entrys = doc.getElementsByTagName("entry");
		//取出xml
		for(int i=0; i<entrys.getLength(); i++){
			Object item = entrys.item(i);
			if (item instanceof Element) {
				Movie_info infos = new Movie_info();
				Element get_douban = (Element) entrys.item(i);
				infos.set_movie_name(get_douban.getElementsByTagName("title")
						.item(0).getFirstChild().getNodeValue());
				infos.set_link_url(get_douban.getElementsByTagName("id")
						.item(0).getFirstChild().getNodeName());
				
				Element node = (Element) get_douban.getElementsByTagName("link")
						.item(2);
				Element node_link_url = (Element) get_douban.getElementsByTagName(
						"link").item(0);
				
				infos.set_link_url(node_link_url.getAttribute("href"));
				infos.set_image_url(node.getAttribute("href"));
				//infos.set_rating(get_douban.getElementsByTagName(arg0));
				try {
					Element entryauthor = (Element) get_douban.getElementsByTagName(
							"author").item(0);//author
					infos.set_director_name(entryauthor
							.getElementsByTagName("name").item(0)
							.getFirstChild().getNodeValue());
				} catch (Exception e) {// 当导演名称为空时 则指定导演为"不详"
					infos.set_director_name("不详");
				}
				result_list.add(infos);
			}
			}
		return result_list;
		}
}
